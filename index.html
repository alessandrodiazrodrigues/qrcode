<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Archipelago QR V3.3 FINAL - Acesso Médico</title>
    
    <style>
        /* =================== RESET E BASE MOBILE =================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: pan-y;
        }
        
        /* =================== LOADING =================== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #334155;
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: #60a5fa;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* =================== CONTAINER MOBILE =================== */
        .container {
            width: 100%;
            min-height: 100vh;
            background: #1a1f2e;
            display: flex;
            flex-direction: column;
        }
        
        /* =================== HEADER MOBILE =================== */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            padding: 20px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .hospital-badge {
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 20px;
            flex: 1;
            text-align: center;
        }
        
        .timer {
            background: rgba(34, 197, 94, 0.25);
            color: #22c55e;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            min-width: 70px;
            text-align: center;
            border: 2px solid rgba(34, 197, 94, 0.4);
        }
        
        .timer.warning {
            background: rgba(245, 158, 11, 0.25);
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.4);
            animation: pulse-warning 1.5s infinite;
        }
        
        .timer.danger {
            background: rgba(239, 68, 68, 0.25);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.4);
            animation: pulse-danger 0.8s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes pulse-danger {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.08); opacity: 0.8; }
        }
        
        /* =================== FORM BODY MOBILE =================== */
        .form-body {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            padding: 12px;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        /* LAYOUT 3 COLUNAS MOBILE */
        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        /* LAYOUT 1 COLUNA */
        .form-row-1 {
            display: grid;
            grid-template-columns: 1fr;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        
        .form-group label .required {
            color: #ef4444;
            font-size: 10px;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px 8px;
            background: #0f172a;
            color: #ffffff;
            border: 2px solid #334155;
            border-radius: 8px;
            font-size: 13px;
            width: 100%;
            box-sizing: border-box;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
            background: #1e293b;
        }
        
        .form-group input[readonly] {
            background: #1f2937;
            color: #6b7280;
            border-color: #374151;
        }
        
        /* Grid 2 colunas para alguns campos */
        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-row-2 .form-group {
            margin-bottom: 0;
        }
        
        .form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            padding-right: 32px;
        }
        
        /* =================== SEÇÕES CHECKBOX MOBILE =================== */
        .form-section {
            margin: 20px 0;
        }
        
        .section-title {
            background: #60a5fa;
            color: #000000;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-align: center;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border: 2px solid #334155;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }
        
        .checkbox-item:active {
            background: rgba(96, 165, 250, 0.15);
            transform: scale(0.98);
        }
        
        .checkbox-item input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: #60a5fa;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .checkbox-item span {
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 500;
            line-height: 1.3;
            user-select: none;
        }
        
        /* =================== ACTIONS MOBILE =================== */
        .actions {
            padding: 15px;
            background: #111827;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
            position: sticky;
            bottom: 0;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            min-height: 54px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: scale(0.97);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #374151;
            color: white;
        }
        
        .btn-qrcode {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* =================== MENSAGENS =================== */
        .message-container {
            width: 100%;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .message-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .message-container h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: 700;
        }
        
        .message-container.error h2 {
            color: #ef4444;
        }
        
        .message-container.success h2 {
            color: #22c55e;
        }
        
        .message-container p {
            color: #cbd5e1;
            margin-bottom: 25px;
            font-size: 15px;
            line-height: 1.6;
            max-width: 400px;
        }
        
        /* =================== RODAPÉ =================== */
        .footer {
            background: rgba(0,0,0,0.4);
            padding: 10px 15px;
            text-align: center;
            font-size: 10px;
            color: #6b7280;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* =================== SCROLLBAR MOBILE =================== */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        /* =================== ANIMAÇÕES =================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .container {
            animation: fadeIn 0.3s ease;
        }
        
        /* =================== ORIENTAÇÃO LANDSCAPE =================== */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px 15px;
            }
            
            .form-body {
                padding: 15px;
            }
            
            .checkbox-grid {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">Carregando dados...</div>
    </div>
    
    <!-- Container Principal -->
    <div id="mainContainer" class="container" style="display: none;"></div>
    
    <!-- Container de Erro -->
    <div id="errorContainer" class="message-container error" style="display: none;">
        <div class="message-icon">⚠️</div>
        <h2>Atenção</h2>
        <p id="errorMessage">Parâmetros inválidos.</p>
        <button class="btn btn-qrcode" onclick="openQRScanner()">LER QR CODE</button>
    </div>
    
    <!-- Container de Sucesso -->
    <div id="successContainer" class="message-container success" style="display: none;">
        <div class="message-icon">✅</div>
        <h2>Sucesso!</h2>
        <p id="successMessage">Operação realizada.</p>
        <p style="margin-top: 15px; font-size: 13px; color: #94a3b8;">Para acessar outro leito, leia o QR Code novamente.</p>
        <button class="btn btn-qrcode" onclick="openQRScanner()">LER QR CODE</button>
    </div>
    
    <script>
// =================== ARCHIPELAGO QR V3.3 MOBILE FINAL - COM LÓGICA DE CONCESSÕES ===================
// =================== CONFIGURAÇÃO ===================
const API_URL = 'https://script.google.com/macros/s/AKfycbyrdmoqC3J08_DM-VRKtHLC0htEJa4PnHeKQVTBsdSt1X1DFhc51axv-6TGyeKjn0Id/exec';

// =================== DADOS GLOBAIS ===================
let hospitalData = {};
let currentHospital = null;
let currentLeito = null;
let timerInterval = null;
let timeLeft = 120;

// =================== CONSTANTES V3.3 ===================
const HOSPITAIS = {
    H1: { nome: 'Neomater', leitos: 10 },
    H2: { nome: 'Cruz Azul', leitos: 36 },
    H3: { nome: 'Santa Marcelina', leitos: 7 },
    H4: { nome: 'Santa Clara', leitos: 13 },
    H5: { nome: 'Adventista', leitos: 13 }
};

const ISOLAMENTO_OPTIONS = [
    "Não Isolamento",
    "Isolamento de Contato", 
    "Isolamento Respiratório"
];

const REGIAO_OPTIONS = [
    'Zona Central',
    'Zona Sul',
    'Zona Norte',
    'Zona Leste',
    'Zona Oeste',
    'ABC',
    'Guarulhos',
    'Osasco',
    'Outra'
];

const SEXO_OPTIONS = [
    'Masculino',
    'Feminino'
];

const HOSPITAIS_HIBRIDOS = ['H1', 'H3', 'H5'];
const SANTA_CLARA_MAX_ENFERMARIAS = 4;

const CRUZ_AZUL_LEITOS_IRMAOS = {
    '21': '22', '22': '21',
    '23': '24', '24': '23',
    '25': '26', '26': '25',
    '27': '28', '28': '27',
    '29': '30', '30': '29',
    '31': '32', '32': '31',
    '33': '34', '34': '33',
    '35': '36', '36': '35'
};

const NUMERACAO_FIXA_CRUZ_AZUL = {
    '21': '711.1', '22': '711.2',
    '23': '713.1', '24': '713.2',
    '25': '715.1', '26': '715.2',
    '27': '717.1', '28': '717.2',
    '29': '719.1', '30': '719.2',
    '31': '721.1', '32': '721.2',
    '33': '723.1', '34': '723.2',
    '35': '725.1', '36': '725.2'
};

const DIRETIVAS_OPTIONS = [
    'Não se aplica',
    'Sim',
    'Não'
];

const CONCESSOES = [
    "Não se aplica",
    "Transição Domiciliar",
    "Aplicação domiciliar de medicamentos",
    "Aspiração",
    "Banho",
    "Curativo",
    "Curativo PICC",
    "Fisioterapia Domiciliar",
    "Fonoaudiologia Domiciliar",
    "Oxigenoterapia",
    "Remoção",
    "Solicitação domiciliar de exames"
];

const LINHAS_CUIDADO = [
    "Assiste",
    "APS SP",
    "Cuidados Paliativos",
    "ICO (Insuficiência Coronariana)",
    "Nexus SP Cardiologia",
    "Nexus SP Gastroentereologia",
    "Nexus SP Geriatria",
    "Nexus SP Pneumologia",
    "Nexus SP Psiquiatria",
    "Nexus SP Reumatologia",
    "Nexus SP Saúde do Fígado",
    "Generalista",
    "Bucomaxilofacial",
    "Cardiologia",
    "Cirurgia Cardíaca",
    "Cirurgia de Cabeça e Pescoço",
    "Cirurgia do Aparelho Digestivo",
    "Cirurgia Geral",
    "Cirurgia Oncológica",
    "Cirurgia Plástica",
    "Cirurgia Torácica",
    "Cirurgia Vascular",
    "Clínica Médica",
    "Coloproctologia",
    "Dermatologia",
    "Endocrinologia",
    "Fisiatria",
    "Gastroenterologia",
    "Geriatria",
    "Ginecologia e Obstetrícia",
    "Hematologia",
    "Infectologia",
    "Mastologia",
    "Nefrologia",
    "Neurocirurgia",
    "Neurologia",
    "Oftalmologia",
    "Oncologia Clínica",
    "Ortopedia",
    "Otorrinolaringologia",
    "Pediatria",
    "Pneumologia",
    "Psiquiatria",
    "Reumatologia",
    "Urologia"
];

const PREVISAO_ALTA = [
    'Hoje Ouro', 'Hoje 2R', 'Hoje 3R',
    '24h Ouro', '24h 2R', '24h 3R',
    '48h', '72h', '96h', 'Sem Previsão'
];

const PPS_OPTIONS = ['10%', '20%', '30%', '40%', '50%', '60%', '70%', '80%', '90%', '100%'];
const IDADE_OPTIONS = Array.from({length: 102}, (_, i) => i + 14);

// =================== INICIALIZAÇÃO ===================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 Archipelago QR V3.3 Mobile - COM LÓGICA DE CONCESSÕES');
    
    const urlParams = new URLSearchParams(window.location.search);
    const hospitalId = urlParams.get('h');
    const leitoNumero = urlParams.get('l');
    
    if (!hospitalId || !leitoNumero) {
        showError('Para acessar o leito, leia o QR Code.');
        return;
    }
    
    if (!HOSPITAIS[hospitalId]) {
        showError('Hospital não reconhecido.');
        return;
    }
    
    const leitoNum = parseInt(leitoNumero);
    if (leitoNum < 1 || leitoNum > HOSPITAIS[hospitalId].leitos) {
        showError(`Leito ${leitoNumero} inválido para ${HOSPITAIS[hospitalId].nome}.`);
        return;
    }
    
    currentHospital = hospitalId;
    currentLeito = leitoNumero;
    
    console.log(`📍 ${HOSPITAIS[hospitalId].nome} - Leito ${leitoNumero}`);
    
    await loadHospitalData(hospitalId);
});

// =================== CARREGAR DADOS ===================
async function loadHospitalData(hospitalId) {
    try {
        console.log('📡 Carregando dados V3.3...');
        
        const response = await fetch(`${API_URL}?action=all`);
        if (!response.ok) throw new Error('Erro na API');
        
        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Erro desconhecido');
        
        if (!data.data || !data.data[hospitalId]) {
            throw new Error(`Hospital ${hospitalId} não encontrado`);
        }
        
        hospitalData = data.data;
        
        const leito = hospitalData[hospitalId].leitos.find(l => 
            String(l.leito || l.numero) === String(currentLeito)
        );
        
        if (!leito) {
            showError(`Leito ${currentLeito} não encontrado.`);
            return;
        }
        
        renderForm(leito);
        startTimer();
        hideLoading();
        
    } catch (error) {
        console.error('❌ Erro:', error);
        showError('Erro ao carregar dados. Tente novamente.');
    }
}

// =================== RENDERIZAR FORMULÁRIO ===================
function renderForm(leito) {
    console.log('📋 Renderizando formulário - ORDEM CORRIGIDA + LÓGICA CONCESSÕES');
    
    const container = document.getElementById('mainContainer');
    const isVago = !leito.status || leito.status === 'Vago' || leito.status === 'vago';
    const hospitalNome = HOSPITAIS[currentHospital].nome;
    const idSequencial = String(currentLeito).padStart(2, '0');
    
    const identificacao = leito.identificacaoLeito || leito.identificacao_leito || leito.identificacao || '';
    const leitoPersonalizado = (identificacao && identificacao.trim()) 
        ? identificacao.trim().toUpperCase()
        : `LEITO ${currentLeito}`;
    
    const idadeOptions = IDADE_OPTIONS.map(idade => 
        `<option value="${idade}" ${leito.idade == idade ? 'selected' : ''}>${idade} anos</option>`
    ).join('');
    
    container.innerHTML = `
        <!-- Header Mobile -->
        <div class="header">
            <div class="header-title">ARCHIPELAGO MEDICAL V3.3</div>
            <div class="header-info">
                <div class="hospital-badge">
                    ${hospitalNome} • ID ${idSequencial} • ${leitoPersonalizado}
                    <span style="color: ${isVago ? '#10b981' : '#f59e0b'}; font-weight: 700; margin-left: 8px;">
                        • ${isVago ? 'VAGO' : 'OCUPADO'}
                    </span>
                </div>
                <div class="timer" id="timer">2:00</div>
            </div>
        </div>
        
        <!-- Form Body -->
        <div class="form-body">
            <h2 class="form-title">${isVago ? 'ADMISSÃO DE PACIENTE' : 'ATUALIZAÇÃO DE DADOS'}</h2>
            
            ${!isVago && leito.dataAdmissao ? `
                <div style="background: #1e293b; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        <div style="flex: 1;">
                            <div style="color: #94a3b8; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">
                                Data de Admissão
                            </div>
                            <div style="color: #e2e8f0; font-size: 14px; font-weight: 600;">
                                ${new Date(leito.dataAdmissao).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                        <div style="flex: 1; text-align: right;">
                            <div style="color: #94a3b8; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 4px;">
                                Tempo Internado
                            </div>
                            <div style="color: #60a5fa; font-size: 14px; font-weight: 700;">
                                ${(() => {
                                    const admissao = new Date(leito.dataAdmissao);
                                    const hoje = new Date();
                                    const diffDays = Math.ceil(Math.abs(hoje - admissao) / (1000 * 60 * 60 * 24));
                                    return diffDays === 1 ? '1 dia' : `${diffDays} dias`;
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- LINHA 1: IDENTIFICAÇÃO | TIPO QUARTO | ISOLAMENTO -->
            <div class="form-row-3">
                <div class="form-group">
                    <label>IDENTIFICAÇÃO <span class="required">*</span></label>
                    ${(() => {
                        const leitoNum = parseInt(currentLeito);
                        const isCruzAzulEnfermaria = (currentHospital === 'H2' && leitoNum >= 21 && leitoNum <= 36);
                        
                        if (isCruzAzulEnfermaria) {
                            const numFixo = NUMERACAO_FIXA_CRUZ_AZUL[String(leitoNum)];
                            return `<input type="text" id="identificacaoLeito" value="${numFixo}" readonly 
                                     style="background: #1f2937; color: #9ca3af; cursor: not-allowed;" required>`;
                        } else {
                            const identificacaoValue = leito.identificacaoLeito || leito.identificacao_leito || leito.identificacao || '';
                            return `<input type="text" id="identificacaoLeito" value="${identificacaoValue}" 
                                     placeholder="Ex: 21 ou 711.1" maxlength="6" required>`;
                        }
                    })()}
                </div>
                <div class="form-group" id="tipoQuartoGroup">
                    <label>TIPO QUARTO <span class="required">*</span></label>
                    ${(() => {
                        const leitoNum = parseInt(currentLeito);
                        
                        if (currentHospital === 'H2' && leitoNum >= 1 && leitoNum <= 20) {
                            return `<select id="tipoQuarto" disabled style="background: #1f2937; color: #9ca3af; cursor: not-allowed;">
                                <option value="Apartamento" selected>Apartamento</option>
                            </select>
                            <input type="hidden" id="tipoQuartoValue" value="Apartamento">
                            <small style="color: rgba(255,255,255,0.5); font-size: 10px; margin-top: 4px; display: block;">
                                🔒 Tipo fixo para este leito
                            </small>`;
                        }
                        
                        if (currentHospital === 'H2' && leitoNum >= 21 && leitoNum <= 36) {
                            return `<select id="tipoQuarto" disabled style="background: #1f2937; color: #9ca3af; cursor: not-allowed;">
                                <option value="Enfermaria" selected>Enfermaria</option>
                            </select>
                            <input type="hidden" id="tipoQuartoValue" value="Enfermaria">
                            <small style="color: rgba(255,255,255,0.5); font-size: 10px; margin-top: 4px; display: block;">
                                🔒 Tipo fixo para este leito
                            </small>`;
                        }
                        
                        const tipoAtual = leito.categoria_escolhida || leito.categoriaEscolhida || leito.categoria || leito.tipo || '';
                        return `<select id="tipoQuarto" required>
                            <option value="">Selecionar...</option>
                            <option value="Apartamento" ${tipoAtual === 'Apartamento' ? 'selected' : ''}>Apartamento</option>
                            <option value="Enfermaria" ${tipoAtual === 'Enfermaria' ? 'selected' : ''} id="opcaoEnfermaria">Enfermaria</option>
                        </select>
                        <div id="avisoLimiteEnfermaria" style="display: none; color: #f59e0b; font-size: 10px; margin-top: 4px; font-weight: 600;">
                            ⚠️ Limite de enfermarias atingido (4/4)
                        </div>`;
                    })()}
                </div>
                <div class="form-group">
                    <label>ISOLAMENTO <span class="required">*</span></label>
                    <select id="isolamento" required>
                        ${ISOLAMENTO_OPTIONS.map((opt, index) => 
                            `<option value="${opt}" ${(leito.isolamento === opt || (index === 0 && !leito.isolamento)) ? 'selected' : ''}>${opt}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <!-- LINHA 2: GÊNERO | REGIÃO | PREVISÃO ALTA -->
            <div class="form-row-3">
                <div class="form-group">
                    <label>GÊNERO <span class="required">*</span></label>
                    <select id="sexo" required>
                        <option value="">Selecionar...</option>
                        ${SEXO_OPTIONS.map(sexo => {
                            const generoAtual = leito.genero || leito.sexo || '';
                            return `<option value="${sexo}" ${generoAtual === sexo ? 'selected' : ''}>${sexo}</option>`;
                        }).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>REGIÃO <span class="required">*</span></label>
                    <select id="regiao" required>
                        <option value="">Selecionar...</option>
                        ${REGIAO_OPTIONS.map(regiao => 
                            `<option value="${regiao}" ${leito.regiao === regiao ? 'selected' : ''}>${regiao}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>PREVISÃO ALTA <span class="required">*</span></label>
                    <select id="prevAlta" required>
                        ${PREVISAO_ALTA.map(p => {
                            const prevAltaAtual = leito.prevAlta === 'SP' ? 'Sem Previsão' : leito.prevAlta;
                            const defaultValue = !leito.prevAlta || leito.prevAlta === 'SP' ? 'Sem Previsão' : leito.prevAlta;
                            return `<option value="${p}" ${prevAltaAtual === p || (!prevAltaAtual && p === 'Sem Previsão') ? 'selected' : ''}>${p}</option>`;
                        }).join('')}
                    </select>
                </div>
            </div>
            
            <!-- LINHA 3: INICIAIS | MATRÍCULA | IDADE -->
            ${isVago ? `
                <div class="form-row-3">
                    <div class="form-group">
                        <label>INICIAIS <span class="required">*</span></label>
                        <input type="text" id="iniciais" placeholder="Ex: J S M" maxlength="10" required>
                    </div>
                    <div class="form-group">
                        <label>MATRÍCULA <span class="required">*</span></label>
                        <input type="text" id="matricula" placeholder="0000000000" maxlength="10" required 
                               oninput="formatarMatricula(this)">
                    </div>
                    <div class="form-group">
                        <label>IDADE <span class="required">*</span></label>
                        <select id="idade" required>
                            <option value="">Selecionar...</option>
                            ${idadeOptions}
                        </select>
                    </div>
                </div>
            ` : `
                <div class="form-row-3">
                    <div class="form-group">
                        <label>INICIAIS</label>
                        <input type="text" value="${leito.nome?.split(' ').map(n => n[0]).join(' ') || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>MATRÍCULA</label>
                        <input type="text" value="${leito.matricula || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>IDADE <span class="required">*</span></label>
                        <select id="idade" required>
                            <option value="">Selecionar...</option>
                            ${idadeOptions}
                        </select>
                    </div>
                </div>
            `}
            
            <!-- LINHA 4: PPS | SPICT-BR | DIRETIVAS -->
            <div class="form-row-3">
                <div class="form-group">
                    <label>PPS <span class="required">*</span></label>
                    <select id="pps" required>
                        <option value="">Selecionar...</option>
                        ${PPS_OPTIONS.map(pps => {
                            let selected = false;
                            if (leito.pps !== null && leito.pps !== undefined && leito.pps !== '') {
                                const ppsStr = String(leito.pps).replace(',', '.');
                                const ppsNum = parseFloat(ppsStr);
                                if (!isNaN(ppsNum)) {
                                    const ppsValue = ppsNum < 1 ? ppsNum * 100 : ppsNum;
                                    const ppsFormatado = `${Math.round(ppsValue / 10) * 10}%`;
                                    selected = ppsFormatado === pps;
                                }
                            }
                            return `<option value="${pps}" ${selected ? 'selected' : ''}>${pps}</option>`;
                        }).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>SPICT-BR <span class="required">*</span></label>
                    <select id="spict" required>
                        <option value="nao_elegivel" ${leito.spict === 'nao_elegivel' || !leito.spict ? 'selected' : ''}>Não elegível</option>
                        <option value="elegivel" ${leito.spict === 'elegivel' ? 'selected' : ''}>Elegível</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>DIRETIVAS <span class="required">*</span></label>
                    <select id="diretivas" required>
                        ${DIRETIVAS_OPTIONS.map((opcao, index) => 
                            `<option value="${opcao}" ${(leito.diretivas === opcao || (index === 0 && !leito.diretivas)) ? 'selected' : ''}>${opcao}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <!-- CONCESSÕES -->
            <div class="form-section">
                <div class="section-title">CONCESSÕES PREVISTAS NA ALTA (${CONCESSOES.length})</div>
                <div class="checkbox-grid">
                    ${CONCESSOES.map((c, i) => `
                        <label class="checkbox-item">
                            <input type="checkbox" id="conc${i}" value="${c}" 
                                ${leito.concessoes && leito.concessoes.includes(c) ? 'checked' : ''}>
                            <span>${c}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            
            <!-- LINHAS DE CUIDADO -->
            <div class="form-section">
                <div class="section-title">LINHAS DE CUIDADO PREVISTAS NA ALTA (${LINHAS_CUIDADO.length})</div>
                <div class="checkbox-grid">
                    ${LINHAS_CUIDADO.map((l, i) => `
                        <label class="checkbox-item">
                            <input type="checkbox" id="linha${i}" value="${l}"
                                ${leito.linhas && leito.linhas.includes(l) ? 'checked' : ''}> 
                            <span>${l}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="actions">
            <button class="btn btn-primary" onclick="saveData()">
                ${isVago ? 'ADMITIR PACIENTE' : 'SALVAR ALTERAÇÕES'}
            </button>
            ${!isVago ? '<button class="btn btn-danger" onclick="darAlta()">DAR ALTA</button>' : ''}
            <button class="btn btn-secondary" onclick="cancelar()">CANCELAR</button>
        </div>
        
        <!-- Rodapé -->
        <div class="footer">
            Archipelago Dashboard V3.3 FINAL - Sistema Médico QR<br>
            Total Rede: 79 leitos | 5 hospitais<br>
            <strong>Criado por:</strong> Dr. Guilherme Santoro | <strong>Desenvolvido por:</strong> Alessandro Rodrigues
        </div>
    `;
    
    container.style.display = 'flex';
    
    // ✅ APLICAR LÓGICA DE CONCESSÕES
    setTimeout(() => {
        configurarLogicaConcessoes(leito);
    }, 100);
    
    // Verificar limite Santa Clara
    setTimeout(async () => {
        if (currentHospital === 'H4') {
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (result.hospitais && result.hospitais.H4) {
                    let enfermariasOcupadas = 0;
                    result.hospitais.H4.leitos.forEach(l => {
                        const ocupado = l.status === 'Em uso' || l.status === 'Ocupado';
                        const tipoEnf = l.tipo === 'Enfermaria';
                        if (ocupado && tipoEnf) enfermariasOcupadas++;
                    });
                    
                    if (enfermariasOcupadas >= 4) {
                        const opcaoEnf = document.getElementById('opcaoEnfermaria');
                        const avisoLimite = document.getElementById('avisoLimiteEnfermaria');
                        
                        if (opcaoEnf) {
                            opcaoEnf.disabled = true;
                            opcaoEnf.textContent = 'Enfermaria (Limite atingido)';
                            opcaoEnf.style.color = '#9ca3af';
                        }
                        
                        if (avisoLimite) {
                            avisoLimite.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar limite Santa Clara:', error);
            }
        }
    }, 100);
}

// =================== ✅ LÓGICA DE CONCESSÕES ===================
function configurarLogicaConcessoes(leito) {
    console.log('🎯 Configurando lógica de concessões');
    
    // Pegar todos os checkboxes de concessões
    const checkboxes = [];
    CONCESSOES.forEach((c, i) => {
        const checkbox = document.getElementById(`conc${i}`);
        if (checkbox) checkboxes.push(checkbox);
    });
    
    if (checkboxes.length === 0) {
        console.warn('⚠️ Nenhum checkbox de concessão encontrado');
        return;
    }
    
    const checkboxNaoSeAplica = checkboxes[0]; // Primeiro checkbox é "Não se aplica"
    const outrosCheckboxes = checkboxes.slice(1); // Resto são as concessões reais
    
    // ✅ REGRA 1: Se nenhuma concessão está marcada, marcar "Não se aplica" automaticamente
    function verificarDefault() {
        const algumaMarcada = outrosCheckboxes.some(cb => cb.checked);
        
        if (!algumaMarcada && !checkboxNaoSeAplica.checked) {
            checkboxNaoSeAplica.checked = true;
            console.log('✅ Nenhuma concessão marcada → "Não se aplica" ativado');
        }
    }
    
    // ✅ REGRA 2: Se "Não se aplica" for marcado, desmarcar todas as outras
    checkboxNaoSeAplica.addEventListener('change', function() {
        if (this.checked) {
            outrosCheckboxes.forEach(cb => {
                cb.checked = false;
            });
            console.log('✅ "Não se aplica" marcado → Todas as outras desmarcadas');
        } else {
            // Se desmarcar "Não se aplica" e não tiver nada marcado, reativar
            setTimeout(verificarDefault, 50);
        }
    });
    
    // ✅ REGRA 3: Se qualquer outra concessão for marcada, desmarcar "Não se aplica"
    outrosCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                checkboxNaoSeAplica.checked = false;
                console.log(`✅ Concessão "${this.value}" marcada → "Não se aplica" desmarcado`);
            } else {
                // Verificar se alguma outra ainda está marcada
                setTimeout(verificarDefault, 50);
            }
        });
    });
    
    // ✅ APLICAR REGRA INICIAL
    verificarDefault();
    
    console.log('✅ Lógica de concessões configurada com sucesso');
}

// =================== FORMATAR MATRÍCULA ===================
function formatarMatricula(input) {
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length > 10) {
        valor = valor.substring(0, 10);
    }
    
    input.value = valor;
}

// =================== TIMER 2 MINUTOS ===================
function startTimer() {
    timeLeft = 120;
    
    timerInterval = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timerEl = document.getElementById('timer');
        
        if (timerEl) {
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 30) {
                timerEl.className = 'timer danger';
            } else if (timeLeft <= 60) {
                timerEl.className = 'timer warning';
            }
        }
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            forceClose('Sessão expirada! (2 minutos)');
        }
    }, 1000);
}

function forceClose(message) {
    showSuccess(message);
}

// =================== VALIDAR BLOQUEIO CRUZ AZUL ===================
async function validarBloqueioCruzAzul(dados) {
    if (dados.hospital !== 'H2') return { valido: true };
    
    const leitoNum = parseInt(dados.leito);
    if (leitoNum < 21 || leitoNum > 36) return { valido: true };
    
    try {
        const leitoIrmao = CRUZ_AZUL_LEITOS_IRMAOS[dados.leito];
        if (!leitoIrmao) return { valido: true };
        
        const response = await fetch(API_URL);
        const result = await response.json();
        
        if (!result.hospitais || !result.hospitais.H2) {
            return { valido: true };
        }
        
        const dadosIrmao = result.hospitais.H2.leitos.find(l => 
            String(l.leito || l.numero) === String(leitoIrmao)
        );
        
        if (!dadosIrmao || dadosIrmao.status === 'Vago' || dadosIrmao.status === 'vago') {
            return { valido: true };
        }
        
        const numFixoIrmao = NUMERACAO_FIXA_CRUZ_AZUL[leitoIrmao];
        
        if (dadosIrmao.isolamento && dadosIrmao.isolamento !== 'Não Isolamento') {
            return {
                valido: false,
                mensagem: `❌ BLOQUEADO POR ISOLAMENTO!\n\nO leito irmão (${numFixoIrmao}) está em ${dadosIrmao.isolamento}.\n\nAguarde a alta para admitir neste leito.`
            };
        }
        
        if (dados.genero && dadosIrmao.sexo && dados.genero !== dadosIrmao.sexo) {
            return {
                valido: false,
                mensagem: `❌ BLOQUEADO POR GÊNERO!\n\nLeito irmão (${numFixoIrmao}) ocupado por paciente ${dadosIrmao.sexo}.\n\nEste leito só pode receber pacientes do sexo ${dadosIrmao.sexo}.`
            };
        }
        
        console.log(`Cruz Azul: Leito ${dados.leito} liberado (irmão ${leitoIrmao} compatível)`);
        return { valido: true };
        
    } catch (error) {
        console.error('Erro ao validar Cruz Azul:', error);
        return { valido: true };
    }
}

// =================== VALIDAR LIMITE SANTA CLARA ===================
async function validarLimiteSantaClara(dados) {
    if (dados.hospital !== 'H4' || dados.tipoQuarto !== 'Enfermaria') {
        return { valido: true };
    }
    
    try {
        const response = await fetch(API_URL);
        const result = await response.json();
        
        if (!result.hospitais || !result.hospitais.H4) {
            return { valido: true };
        }
        
        let enfermariasOcupadas = 0;
        result.hospitais.H4.leitos.forEach(leito => {
            const statusOcupado = leito.status === 'Em uso' || leito.status === 'Ocupado';
            const tipoEnfermaria = leito.tipo === 'Enfermaria';
            
            if (statusOcupado && tipoEnfermaria) {
                enfermariasOcupadas++;
            }
        });
        
        console.log(`Santa Clara: ${enfermariasOcupadas} enfermarias ocupadas (limite: 4)`);
        
        if (enfermariasOcupadas >= SANTA_CLARA_MAX_ENFERMARIAS) {
            return {
                valido: false,
                mensagem: `❌ LIMITE ATINGIDO!\n\nO Santa Clara já possui ${SANTA_CLARA_MAX_ENFERMARIAS} enfermarias ocupadas (máximo permitido).\n\nAguarde uma alta ou admita como Apartamento.`
            };
        }
        
        return { valido: true };
        
    } catch (error) {
        console.error('Erro ao validar limite:', error);
        return { valido: true };
    }
}

// =================== SALVAR DADOS ===================
async function saveData() {
    try {
        const dados = coletarDados();
        
        const validacaoCA = await validarBloqueioCruzAzul(dados);
        if (!validacaoCA.valido) {
            alert(validacaoCA.mensagem);
            return;
        }
        
        const validacaoSC = await validarLimiteSantaClara(dados);
        if (!validacaoSC.valido) {
            alert(validacaoSC.mensagem);
            return;
        }
        
        if (!validarDados(dados)) return;
        
        const leito = hospitalData[currentHospital].leitos.find(l => 
            String(l.leito || l.numero) === String(currentLeito)
        );
        const isVago = !leito.status || leito.status === 'Vago' || leito.status === 'vago';
        
        const payload = {
            action: isVago ? 'admitir' : 'atualizar',
            hospital: currentHospital,
            leito: currentLeito,
            ...dados
        };
        
        if (isVago && dados.iniciais) {
            payload.nome = dados.iniciais;
            delete payload.iniciais;
        }
        
        console.log('📤 Enviando V3.3:', payload);
        
        const params = new URLSearchParams();
        for (const [key, value] of Object.entries(payload)) {
            if (Array.isArray(value)) {
                const filtered = key === 'concessoes' 
                    ? value.filter(v => v !== 'Não se aplica')
                    : value;
                params.append(key, filtered.join(','));
            } else if (value !== null && value !== undefined) {
                params.append(key, String(value));
            }
        }
        
        const response = await fetch(`${API_URL}?${params.toString()}`);
        const result = await response.json();
        
        if (!result.ok) throw new Error(result.error || 'Erro ao salvar');
        
        clearInterval(timerInterval);
        const message = isVago ? 'Paciente admitido com sucesso!' : 'Dados atualizados com sucesso!';
        showSuccess(message);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        alert('Erro ao salvar: ' + error.message);
    }
}

// =================== DAR ALTA ===================
async function darAlta() {
    if (!confirm('Confirma a ALTA deste paciente?')) return;
    
    try {
        const params = new URLSearchParams({
            action: 'daralta',
            hospital: currentHospital,
            leito: currentLeito
        });
        
        const response = await fetch(`${API_URL}?${params.toString()}`);
        const result = await response.json();
        
        if (!result.ok) throw new Error(result.error || 'Erro ao dar alta');
        
        clearInterval(timerInterval);
        showSuccess('Alta processada com sucesso!');
        
    } catch (error) {
        console.error('❌ Erro:', error);
        alert('Erro ao processar alta: ' + error.message);
    }
}

// =================== COLETAR DADOS ===================
function coletarDados() {
    const dados = {};
    
    const iniciais = document.getElementById('iniciais');
    if (iniciais) dados.iniciais = iniciais.value.trim();
    
    const matricula = document.getElementById('matricula');
    if (matricula) dados.matricula = matricula.value.trim();
    
    const idade = document.getElementById('idade');
    if (idade && idade.value) dados.idade = parseInt(idade.value);
    
    dados.pps = document.getElementById('pps').value.replace('%', '');
    dados.spict = document.getElementById('spict').value;
    dados.prevAlta = document.getElementById('prevAlta').value;
    dados.isolamento = document.getElementById('isolamento').value;
    dados.identificacaoLeito = document.getElementById('identificacaoLeito').value.trim().toUpperCase();
    dados.regiao = document.getElementById('regiao').value;
    dados.genero = document.getElementById('sexo').value;
    dados.diretivas = document.getElementById('diretivas').value;
    
    const tipoQuartoField = document.getElementById('tipoQuarto');
    const tipoQuartoValue = document.getElementById('tipoQuartoValue');
    
    if (tipoQuartoValue) {
        dados.tipoQuarto = tipoQuartoValue.value;
        dados.categoria = tipoQuartoValue.value;
        dados.categoria_escolhida = tipoQuartoValue.value;
    } else if (tipoQuartoField && tipoQuartoField.value) {
        dados.tipoQuarto = tipoQuartoField.value;
        dados.categoria = tipoQuartoField.value;
        dados.categoria_escolhida = tipoQuartoField.value;
    }
    
    dados.concessoes = [];
    CONCESSOES.forEach((_, i) => {
        const cb = document.getElementById(`conc${i}`);
        if (cb && cb.checked) dados.concessoes.push(cb.value);
    });
    
    dados.linhas = [];
    LINHAS_CUIDADO.forEach((_, i) => {
        const cb = document.getElementById(`linha${i}`);
        if (cb && cb.checked) dados.linhas.push(cb.value);
    });
    
    console.log('📋 Dados coletados');
    
    return dados;
}

// =================== VALIDAR DADOS ===================
function validarDados(dados) {
    const erros = [];
    
    if (dados.iniciais !== undefined && !dados.iniciais) {
        erros.push('• Iniciais são obrigatórias');
    }
    
    if (dados.matricula !== undefined && !dados.matricula) {
        erros.push('• Matrícula é obrigatória');
    }
    
    if (dados.matricula && dados.matricula.length > 10) {
        erros.push('• Matrícula: máximo 10 dígitos');
    }
    
    if (!dados.idade) {
        erros.push('• Idade é obrigatória');
    }
    
    if (!dados.pps) erros.push('• PPS é obrigatório');
    if (!dados.spict) erros.push('• SPICT-BR é obrigatório');
    if (!dados.prevAlta) erros.push('• Previsão de Alta é obrigatória');
    if (!dados.isolamento) erros.push('• Isolamento é obrigatório');
    if (!dados.identificacaoLeito) erros.push('• Identificação do Leito é obrigatória');
    if (!dados.regiao) erros.push('• Região é obrigatória');
    if (!dados.genero) erros.push('• Gênero é obrigatório');
    if (!dados.diretivas) erros.push('• Diretivas são obrigatórias');
    
    if (dados.identificacaoLeito && dados.identificacaoLeito.length > 6) {
        erros.push('• Identificação do Leito: máximo 6 caracteres');
    }
    
    if (erros.length > 0) {
        alert('CAMPOS OBRIGATÓRIOS:\n\n' + erros.join('\n'));
        return false;
    }
    
    return true;
}

// =================== CANCELAR ===================
function cancelar() {
    if (confirm('Cancelar a operação?')) {
        clearInterval(timerInterval);
        showSuccess('Operação cancelada.');
    }
}

// =================== ABRIR QR SCANNER ===================
function openQRScanner() {
    alert('Abrindo câmera para leitura de QR Code...\n\n(Requer biblioteca de scanner QR integrada)');
}

// =================== UTILS ===================
function hideLoading() {
    const loading = document.getElementById('loading');
    if (loading) loading.classList.add('hidden');
}

function showError(message) {
    hideLoading();
    
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('successContainer').style.display = 'none';
    
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').style.display = 'flex';
    
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function showSuccess(message) {
    hideLoading();
    
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('errorContainer').style.display = 'none';
    
    document.getElementById('successMessage').textContent = message;
    document.getElementById('successContainer').style.display = 'flex';
    
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// =================== LOG INICIALIZAÇÃO ===================
console.log('✅ Archipelago QR V3.3 MOBILE - ORDEM CORRIGIDA + LÓGICA CONCESSÕES');
console.log('📱 Otimizado para mobile');
console.log('⏱️ Timer: 2 minutos com fechamento forçado');
console.log('🏥 Total Rede: 79 leitos | 5 hospitais');
console.log('');
console.log('✅ ORDEM DOS CAMPOS CORRIGIDA:');
console.log('Linha 1: IDENTIFICAÇÃO | TIPO QUARTO | ISOLAMENTO');
console.log('Linha 2: GÊNERO | REGIÃO | PREVISÃO ALTA');
console.log('Linha 3: INICIAIS | MATRÍCULA | IDADE');
console.log('Linha 4: PPS | SPICT-BR | DIRETIVAS');
console.log('');
console.log('✅ LÓGICA DE CONCESSÕES:');
console.log('• Se nenhuma marcada → "Não se aplica" ativado');
console.log('• Se "Não se aplica" marcado → Outras desmarcadas');
console.log('• Se outra marcada → "Não se aplica" desmarcado');
    </script>
</body>
</html>
